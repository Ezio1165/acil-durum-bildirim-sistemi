<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Kontrolcüsü</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .btn-press { transition: transform 0.1s; }
        .btn-press:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-black text-white h-screen flex flex-col overflow-hidden">

    <!-- Üst Başlık -->
    <div class="p-6 flex items-center justify-between bg-gray-900 border-b border-gray-800">
        <h2 class="text-lg font-bold text-gray-200 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
            Mobil Kumanda
        </h2>
        <div id="connectionStatus" class="w-3 h-3 rounded-full bg-yellow-500 animate-pulse"></div>
    </div>

    <!-- Ana İçerik -->
    <div class="flex-1 flex flex-col p-6 space-y-8 justify-center">

        <!-- Durum Göstergesi -->
        <div class="text-center space-y-2">
            <p class="text-gray-500 text-xs tracking-[0.2em] uppercase font-bold">BİLGİSAYAR DURUMU</p>
            <div id="statusText" class="text-4xl font-black transition-colors duration-300 text-green-500">
                BAĞLANIYOR...
            </div>
        </div>

        <!-- Mesaj Input -->
        <div class="bg-gray-900 p-4 rounded-2xl border border-gray-800 focus-within:border-gray-600 transition-colors">
            <label class="text-[10px] text-gray-500 mb-2 block uppercase font-bold tracking-wider">EKRANDA GÖRÜNECEK MESAJ</label>
            <input 
                type="text" 
                id="messageInput"
                placeholder="Lütfen bilgisayarı terk edin!"
                class="w-full bg-transparent text-white text-lg placeholder-gray-600 focus:outline-none font-medium"
            />
        </div>

        <!-- Ana Buton -->
        <button id="toggleBtn" class="w-full py-6 rounded-2xl font-bold text-xl shadow-lg btn-press flex items-center justify-center gap-3 bg-gray-800 text-gray-400 cursor-not-allowed transition-all duration-300">
            <svg class="animate-spin h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            SİSTEM YÜKLENİYOR
        </button>

    </div>

    <div class="p-6 text-center">
        <p class="text-gray-700 text-xs">v1.5 • Firebase Config Check</p>
    </div>

    <!-- Firebase SDK & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- AYARLAR ---
        let firebaseConfig;
        let appId = "default-app-id";

        // 1. Ortam Kontrolü: Eğer bu kod Canvas önizlemesinde çalışıyorsa, sistem ayarlarını otomatik al.
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            if (typeof __app_id !== 'undefined') appId = __app_id;
        } else {
            // 2. TELEFONDA ÇALIŞMASI İÇİN BURAYI DOLDURMAN ŞART
            // Firebase Konsolu -> Project Settings -> General -> Your apps kısmından alabilirsin.
            // "BURAYI_DOLDURUN" yazılarını silip tırnak içinde kendi kodlarını yapıştır.
            
            firebaseConfig = {
                apiKey: "SENIN_API_KEYIN",
                authDomain: "SENIN_PROJECT_ID.firebaseapp.com",
                projectId: "SENIN_PROJECT_ID",
                storageBucket: "SENIN_PROJECT_ID.appspot.com",
                messagingSenderId: "...",
                appId: "..."
            };          
        }

        // Başlatma (Hata yakalama ile)
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase Başlatma Hatası:", e);
            document.getElementById('statusText').innerText = "AYAR HATASI";
            document.getElementById('statusText').className = "text-2xl font-black text-red-500";
            alert("Firebase ayarları hatalı veya eksik. Lütfen kodu düzenleyip API Key bilgilerinizi girin.");
        }

        // UI Referansları
        const statusText = document.getElementById('statusText');
        const toggleBtn = document.getElementById('toggleBtn');
        const messageInput = document.getElementById('messageInput');
        const connStatus = document.getElementById('connectionStatus');

        let isActive = false;
        let currentMessage = "Lütfen bilgisayarı terk edin!";

        // Buton Tasarımları
        const STYLE_ACTIVE = "bg-green-600 hover:bg-green-500 text-white shadow-green-900/40";
        const STYLE_PASSIVE = "bg-red-600 hover:bg-red-500 text-white shadow-red-900/40";

        // YENİ AUTH MANTIĞI: Token varsa onu kullan, yoksa anonim gir
        async function initAuth() {
            if (!auth) return; // Firebase başlatılamadıysa dur.

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Giriş başarılı");
                startListening();
            } catch (error) {
                console.error("Giriş hatası:", error);
                // Hata detayını ekranda gösterelim ki kullanıcı anlasın
                statusText.innerText = "BAĞLANTI YOK";
                statusText.style.fontSize = "1.5rem";
                
                // Kullanıcıya daha anlamlı hata mesajı
                let errorMsg = "Bağlantı hatası.";
                if (error.code === 'auth/api-key-not-valid.-please-pass-a-valid-api-key.') {
                    errorMsg = "API KEY GEÇERSİZ. Kod içindeki ayarları kontrol edin.";
                } else if (error.code === 'auth/internal-error') {
                    errorMsg = "İnternet bağlantınızı kontrol edin.";
                }
                
                alert("Hata: " + errorMsg + "\n(" + error.message + ")");
                
                statusText.className = "text-2xl font-black text-red-500";
                connStatus.className = "w-3 h-3 rounded-full bg-red-500";
                toggleBtn.innerHTML = "ÇEVRİMDIŞI";
            }
        }

        // Auth Başlat
        initAuth();

        function startListening() {
            // Masaüstü ile aynı yolu dinle (appId dinamik hale getirildi)
            const docRef = doc(db, "artifacts", appId, "public", "data", "alerts", "status");

            // Veriyi Dinle
            onSnapshot(docRef, (docSnap) => {
                connStatus.className = "w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.8)]"; // Bağlı ışığı yeşil

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    isActive = data.active;
                    
                    // UI Güncelle
                    if (isActive) {
                        statusText.innerText = "ALARM AKTİF";
                        statusText.className = "text-4xl font-black text-red-500 drop-shadow-[0_0_15px_rgba(239,68,68,0.5)]";
                        
                        toggleBtn.className = `w-full py-6 rounded-2xl font-bold text-xl shadow-lg btn-press flex items-center justify-center gap-3 transition-all duration-300 ${STYLE_ACTIVE}`;
                        toggleBtn.innerHTML = `
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            ALARMI KAPAT
                        `;
                    } else {
                        statusText.innerText = "NORMAL";
                        statusText.className = "text-4xl font-black text-green-500";
                        
                        toggleBtn.className = `w-full py-6 rounded-2xl font-bold text-xl shadow-lg btn-press flex items-center justify-center gap-3 transition-all duration-300 ${STYLE_PASSIVE}`;
                        toggleBtn.innerHTML = `
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                            ALARMI BAŞLAT
                        `;
                    }

                    // Input'u senkronize et (Eğer boşsa)
                    if (messageInput.value === "" && data.message) {
                        messageInput.value = data.message;
                    }
                    
                    toggleBtn.disabled = false;
                } else {
                    // İlk kez çalışıyorsa veritabanını oluştur
                    setDoc(docRef, { active: false, message: currentMessage });
                }
            }, (error) => {
                console.error("Dinleme hatası:", error);
                connStatus.className = "w-3 h-3 rounded-full bg-red-500";
                
                // İzin hatası kontrolü
                if(error.code === 'permission-denied') {
                     alert("Veritabanı okuma izni yok. Firestore Kurallarını (Rules) 'allow read, write: if true;' yaptığınızdan emin olun.");
                }
            });

            // Buton Tıklama Olayı
            toggleBtn.onclick = async () => {
                // Yükleniyor durumuna geç
                toggleBtn.disabled = true;
                const oldContent = toggleBtn.innerHTML;
                toggleBtn.innerHTML = `<svg class="animate-spin h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
                
                const msgToSend = messageInput.value.trim() !== "" ? messageInput.value : "Lütfen bilgisayarı terk edin!";

                try {
                    // Tam tersi durumu gönder (Açıksa kapat, kapalıysa aç)
                    await setDoc(docRef, {
                        active: !isActive,
                        message: msgToSend,
                        timestamp: Date.now()
                    }, { merge: true });
                    
                    // Başarılı olunca onSnapshot zaten UI'ı güncelleyecek
                } catch (err) {
                    alert("Komut gönderilemedi: " + err.message);
                    toggleBtn.innerHTML = oldContent;
                    toggleBtn.disabled = false;
                }
            };
        }
    </script>
</body>
</html>